<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Debug</title>
  <link rel="stylesheet" href="/style.css">
  <script defer src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>
</head>
<body>
  <main>
    <div class="md" style="max-width:680px;margin:8vh auto;">
      <h1>Debug</h1>
      <p id="state"></p>
      <pre id="data"></pre>
      <div style="display:flex;gap:10px;justify-content:center;margin-top:16px;">
        <button class="btn" id="login">Login mit Google</button>
        <button class="btn" id="logout">Logout</button>
        <button class="btn primary" id="refresh">Neu laden</button>
      </div>
    </div>
  </main>
  <script>
    const state=document.getElementById("state");
    const data=document.getElementById("data");
    function hasAllowed(u){try{return (u&&u.app_metadata&&Array.isArray(u.app_metadata.roles)&&u.app_metadata.roles.includes("allowed"));}catch(e){return false}}
    function show(u){
      const roles=(u&&u.app_metadata&&u.app_metadata.roles)||[];
      state.textContent="User: "+(u?u.email:"none")+" | Roles: "+JSON.stringify(roles);
      data.textContent="nf_jwt="+(document.cookie.match(/(?:^|;)\\s*nf_jwt=([^;]+)/)?.[1]||"")+"\n"+JSON.stringify(u||{},null,2);
    }
    document.getElementById("login").onclick=()=>window.netlifyIdentity&&netlifyIdentity.open("login");
    document.getElementById("logout").onclick=()=>window.netlifyIdentity&&netlifyIdentity.logout();
    document.getElementById("refresh").onclick=()=>location.reload();
    function start(){
      if(!window.netlifyIdentity){state.textContent="Identity nicht geladen";return;}
      netlifyIdentity.on("init",show);
      netlifyIdentity.on("login",u=>{ if(hasAllowed(u)){ u.jwt().then(t=>{document.cookie="nf_jwt="+t+"; Path=/; Secure; SameSite=Strict"; location.href="/";}); } else { show(u); state.insertAdjacentHTML("beforeend","<p style='margin-top:10px;color:var(--muted)'>Angemeldet. Warte auf Freigabeâ€¦</p>"); }});
      netlifyIdentity.on("logout",()=>{document.cookie="nf_jwt=; Max-Age=0; Path=/; Secure; SameSite=Strict"; show(null);});
      netlifyIdentity.on("error",e=>{state.textContent="Identity Error"; data.textContent=String(e);});
      netlifyIdentity.init();
      const u=netlifyIdentity.currentUser();
      if(u) show(u);
    }
    document.addEventListener("DOMContentLoaded",start);
  </script>
</body>
</html>
