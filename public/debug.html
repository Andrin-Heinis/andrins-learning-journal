<script>
  const state = document.getElementById("state");
  const data = document.getElementById("data");
  function show(u) {
    const roles = (u && u.app_metadata && u.app_metadata.roles) || [];
    state.textContent =
      "User: " + (u ? u.email : "none") + " | Roles: " + JSON.stringify(roles);
    data.textContent =
      "nf_jwt=" +
      (document.cookie.match(/(?:^|;)\s*nf_jwt=([^;]+)/)?.[1] || "") +
      "\n" +
      JSON.stringify(u || {}, null, 2);
  }

  document.getElementById("login").onclick = () =>
    window.netlifyIdentity && netlifyIdentity.open("login");
  document.getElementById("logout").onclick = () =>
    window.netlifyIdentity && netlifyIdentity.logout();
  document.getElementById("refresh").onclick = () => location.reload();

  function start() {
    if (!window.netlifyIdentity) {
      state.textContent = "Identity nicht geladen";
      return;
    }
    netlifyIdentity.on("init", show);
    netlifyIdentity.on("login", (u) => {
      u.jwt().then((t) => {
        document.cookie = "nf_jwt=" + t + "; Path=/; Secure; SameSite=Strict";
        location.href = "/";
      });
    });
    netlifyIdentity.on("logout", () => {
      document.cookie = "nf_jwt=; Max-Age=0; Path=/; Secure; SameSite=Strict";
      show(null);
    });
    netlifyIdentity.on("error", (e) => {
      state.textContent = "Identity Error";
      data.textContent = String(e);
    });
    netlifyIdentity.init();
    const u = netlifyIdentity.currentUser();
    if (u) show(u);
  }

  document.addEventListener("DOMContentLoaded", start);
</script>
